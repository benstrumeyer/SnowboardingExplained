import React, { useState, useEffect } from 'react';\nimport {\n  View,\n  Text,\n  StyleSheet,\n  ScrollView,\n  ActivityIndicator,\n  Image,\n  Dimensions,\n} from 'react-native';\nimport { api } from '../services/api';\nimport { PoseData } from '../services/poseAnalysisService';\nimport { SkeletonRenderer } from '../components/SkeletonRenderer';\nimport { SummaryPanel } from '../components/SummaryPanel';\nimport { FrameNavigationControls } from '../components/FrameNavigationControls';\n\ninterface PerfectPhaseDetailScreenProps {\n  phaseId: string;\n  trickName: string;\n  phaseName: string;\n  stance: string;\n}\n\ninterface PerfectPhaseData {\n  id: string;\n  trickName: string;\n  phaseName: string;\n  stance: string;\n  frames: {\n    frameNumber: number;\n    imageRaw: string;\n    imageMeshOverlay: string;\n    poseData: PoseData;\n  }[];\n  dataQuality: {\n    averageConfidence: number;\n    highConfidenceFrames: number;\n    mediumConfidenceFrames: number;\n    lowConfidenceFrames: number;\n    qualityIndicator: string;\n  };\n}\n\nexport const PerfectPhaseDetailScreen: React.FC<\n  PerfectPhaseDetailScreenProps\n> = ({ phaseId, trickName, phaseName, stance }) => {\n  const [phaseData, setPhaseData] = useState<PerfectPhaseData | null>(null);\n  const [currentFrameIndex, setCurrentFrameIndex] = useState(0);\n  const [isLoading, setIsLoading] = useState(true);\n\n  const screenWidth = Dimensions.get('window').width;\n  const frameHeight = (screenWidth * 9) / 16;\n\n  useEffect(() => {\n    loadPhaseData();\n  }, [phaseId]);\n\n  const loadPhaseData = async () => {\n    setIsLoading(true);\n    try {\n      const response = await api.get(`/api/perfect-phases/${phaseId}`);\n      setPhaseData(response.data);\n      setCurrentFrameIndex(0);\n    } catch (error) {\n      console.error('Failed to load perfect phase data:', error);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const handleBack = () => {\n    if (currentFrameIndex > 0) {\n      setCurrentFrameIndex(currentFrameIndex - 1);\n    }\n  };\n\n  const handleNext = () => {\n    if (phaseData && currentFrameIndex < phaseData.frames.length - 1) {\n      setCurrentFrameIndex(currentFrameIndex + 1);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <View style={styles.loadingContainer}>\n        <ActivityIndicator size=\"large\" color=\"#007AFF\" />\n        <Text style={styles.loadingText}>Loading perfect phase...</Text>\n      </View>\n    );\n  }\n\n  if (!phaseData) {\n    return (\n      <View style={styles.errorContainer}>\n        <Text style={styles.errorText}>Failed to load perfect phase</Text>\n      </View>\n    );\n  }\n\n  const currentFrame = phaseData.frames[currentFrameIndex];\n  const qualityColor =\n    phaseData.dataQuality.qualityIndicator === 'excellent'\n      ? '#34C759'\n      : phaseData.dataQuality.qualityIndicator === 'good'\n      ? '#FF9500'\n      : '#FF3B30';\n\n  return (\n    <View style={styles.container}>\n      {/* Header */}\n      <View style={styles.header}>\n        <Text style={styles.title}>{trickName}</Text>\n        <View style={styles.headerBadges}>\n          <View style={styles.badge}>\n            <Text style={styles.badgeText}>{phaseName}</Text>\n          </View>\n          <View style={styles.badge}>\n            <Text style={styles.badgeText}>{stance}</Text>\n          </View>\n        </View>\n      </View>\n\n      {/* Data Quality Metrics */}\n      <View style={styles.metricsContainer}>\n        <View style={styles.metricRow}>\n          <Text style={styles.metricLabel}>Average Confidence</Text>\n          <View\n            style={[\n              styles.metricBadge,\n              { backgroundColor: qualityColor },\n            ]}\n          >\n            <Text style={styles.metricBadgeText}>\n              {(phaseData.dataQuality.averageConfidence * 100).toFixed(0)}%\n            </Text>\n          </View>\n        </View>\n\n        <View style={styles.metricRow}>\n          <Text style={styles.metricLabel}>Quality</Text>\n          <Text\n            style={[\n              styles.metricValue,\n              { color: qualityColor },\n            ]}\n          >\n            {phaseData.dataQuality.qualityIndicator.toUpperCase()}\n          </Text>\n        </View>\n\n        <View style={styles.confidenceBreakdown}>\n          <View style={styles.breakdownItem}>\n            <Text style={styles.breakdownLabel}>High</Text>\n            <Text style={styles.breakdownValue}>\n              {phaseData.dataQuality.highConfidenceFrames}\n            </Text>\n          </View>\n          <View style={styles.breakdownItem}>\n            <Text style={styles.breakdownLabel}>Medium</Text>\n            <Text style={styles.breakdownValue}>\n              {phaseData.dataQuality.mediumConfidenceFrames}\n            </Text>\n          </View>\n          <View style={styles.breakdownItem}>\n            <Text style={styles.breakdownLabel}>Low</Text>\n            <Text style={styles.breakdownValue}>\n              {phaseData.dataQuality.lowConfidenceFrames}\n            </Text>\n          </View>\n        </View>\n      </View>\n\n      {/* Frame Display */}\n      <View style={[styles.frameContainer, { height: frameHeight }]}>\n        <Image\n          source={{ uri: currentFrame.imageRaw }}\n          style={styles.frameImage}\n        />\n\n        {currentFrame.poseData && (\n          <View style={styles.overlayContainer}>\n            <SkeletonRenderer poseData={currentFrame.poseData} />\n          </View>\n        )}\n      </View>\n\n      {/* Summary Panel */}\n      {currentFrame.poseData && (\n        <View style={styles.summaryContainer}>\n          <SummaryPanel\n            poseData={currentFrame.poseData}\n            phaseReasoning={`Frame ${currentFrameIndex + 1} of perfect ${phaseName} phase`}\n            mcpToolOutputs={[]}\n          />\n        </View>\n      )}\n\n      {/* Frame Navigation */}\n      <FrameNavigationControls\n        currentFrame={currentFrameIndex}\n        totalFrames={phaseData.frames.length}\n        onBack={handleBack}\n        onNext={handleNext}\n      />\n    </View>\n  );\n};\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n    backgroundColor: '#f5f5f5',\n  },\n  loadingContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#f5f5f5',\n  },\n  loadingText: {\n    marginTop: 12,\n    fontSize: 14,\n    color: '#666',\n  },\n  errorContainer: {\n    flex: 1,\n    justifyContent: 'center',\n    alignItems: 'center',\n    backgroundColor: '#f5f5f5',\n  },\n  errorText: {\n    fontSize: 14,\n    color: '#FF3B30',\n  },\n  header: {\n    backgroundColor: '#fff',\n    paddingHorizontal: 16,\n    paddingVertical: 12,\n    borderBottomWidth: 1,\n    borderBottomColor: '#e0e0e0',\n  },\n  title: {\n    fontSize: 20,\n    fontWeight: '700',\n    color: '#000',\n    marginBottom: 8,\n  },\n  headerBadges: {\n    flexDirection: 'row',\n    gap: 8,\n  },\n  badge: {\n    backgroundColor: '#f0f0f0',\n    paddingHorizontal: 10,\n    paddingVertical: 6,\n    borderRadius: 6,\n  },\n  badgeText: {\n    fontSize: 12,\n    fontWeight: '600',\n    color: '#666',\n  },\n  metricsContainer: {\n    backgroundColor: '#fff',\n    marginHorizontal: 12,\n    marginVertical: 8,\n    borderRadius: 8,\n    padding: 12,\n  },\n  metricRow: {\n    flexDirection: 'row',\n    justifyContent: 'space-between',\n    alignItems: 'center',\n    paddingVertical: 8,\n    borderBottomWidth: 1,\n    borderBottomColor: '#f0f0f0',\n  },\n  metricLabel: {\n    fontSize: 12,\n    fontWeight: '600',\n    color: '#666',\n  },\n  metricBadge: {\n    paddingHorizontal: 10,\n    paddingVertical: 4,\n    borderRadius: 4,\n  },\n  metricBadgeText: {\n    fontSize: 12,\n    fontWeight: '600',\n    color: '#fff',\n  },\n  metricValue: {\n    fontSize: 12,\n    fontWeight: '600',\n  },\n  confidenceBreakdown: {\n    flexDirection: 'row',\n    justifyContent: 'space-around',\n    marginTop: 12,\n    paddingTop: 12,\n    borderTopWidth: 1,\n    borderTopColor: '#f0f0f0',\n  },\n  breakdownItem: {\n    alignItems: 'center',\n  },\n  breakdownLabel: {\n    fontSize: 10,\n    color: '#999',\n    marginBottom: 4,\n  },\n  breakdownValue: {\n    fontSize: 14,\n    fontWeight: '700',\n    color: '#000',\n  },\n  frameContainer: {\n    backgroundColor: '#000',\n    position: 'relative',\n    overflow: 'hidden',\n  },\n  frameImage: {\n    width: '100%',\n    height: '100%',\n    resizeMode: 'contain',\n  },\n  overlayContainer: {\n    position: 'absolute',\n    top: 0,\n    left: 0,\n    right: 0,\n    bottom: 0,\n  },\n  summaryContainer: {\n    flex: 1,\n    maxHeight: 250,\n    backgroundColor: '#f5f5f5',\n  },\n});\n