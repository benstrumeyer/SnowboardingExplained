# LLM Prompt Design for Temporal Signal Analysis

## Overview

The LLM is used to analyze uploaded signal sequences and provide insights about body part movements, coordination patterns, and coaching suggestions. The LLM receives pose data and temporal signals, then returns structured analysis.

**Important**: The LLM analyzes and understands movement patterns, but does NOT make coaching decisions. Coaching feedback is generated by the comparison engine based on mathematical deltas.

## Input to LLM

The LLM receives:
1. Pose keypoints for key frames (start, middle, end)
2. Extracted temporal signals (position, velocity, acceleration curves)
3. Body part relationships
4. Signal metadata (name, phases, description)

**Example Input**:
```json
{
  "signalName": "counter_rotation",
  "phases": ["air", "landing"],
  "description": "Upper body slows rotation, lower body speeds up",
  "frameCount": 30,
  "duration": 1.0,
  "fps": 30,
  
  "keyFrames": {
    "start": {
      "frameNumber": 56,
      "keypoints": [
        {"name": "left_shoulder", "x": 100, "y": 150, "z": 0},
        {"name": "right_shoulder", "x": 200, "y": 150, "z": 0},
        {"name": "left_hip", "x": 110, "y": 300, "z": 0},
        {"name": "right_hip", "x": 190, "y": 300, "z": 0},
        ...
      ]
    },
    "middle": { ... },
    "end": { ... }
  },
  
  "temporalSignals": {
    "upper_body_rotation": {
      "position": [45, 42, 38, 32, 25, 18, 12, 8, 5, 3],
      "velocity": [-3, -4, -6, -7, -7, -6, -4, -3, -2],
      "acceleration": [-1, -2, -1, 0, 1, 2, 2, 1],
      "peakMagnitude": 45,
      "peakTiming": 0.0
    },
    "lower_body_rotation": {
      "position": [0, 2, 5, 9, 14, 20, 26, 31, 35, 38],
      "velocity": [2, 3, 4, 5, 6, 6, 5, 4, 3],
      "acceleration": [1, 1, 1, 1, 0, -1, -1, -1],
      "peakMagnitude": 38,
      "peakTiming": 1.0
    }
  },
  
  "relationships": {
    "upper_vs_lower_separation": {
      "separation": [45, 40, 33, 23, 11, -2, -14, -23, -30, -35],
      "coordination": -0.95
    }
  }
}
```

## LLM Prompt

### System Prompt

```
You are an expert snowboarding coach analyzing movement patterns from pose data.

Your role is to:
1. Identify which body parts are moving during this signal sequence
2. Describe the movement pattern in coaching terms
3. Identify acceleration vs deceleration patterns
4. Suggest related signal sequences
5. Flag any asymmetries or coordination issues

You receive pose keypoints and temporal signals (position, velocity, acceleration curves).

IMPORTANT: You are analyzing and understanding movement patterns, NOT making coaching decisions.
Your analysis helps categorize and understand the movement, but the actual coaching feedback
comes from mathematical comparison to a perfect reference.

Respond in JSON format with the following structure:
{
  "bodyPartsInvolved": ["upper_body", "lower_body", "arms"],
  "movementType": "counter_rotation",
  "description": "Upper body decelerates rotation while lower body accelerates",
  "acceleratingParts": ["lower_body"],
  "deceleratingParts": ["upper_body"],
  "coordinationPattern": "inverse - one speeds up as other slows down",
  "asymmetries": [],
  "relatedSignals": ["arm_snap", "body_separation"],
  "coachingInsights": [
    "This is a key transition movement",
    "Requires precise timing between upper and lower body"
  ],
  "suggestedName": "counter_rotation",
  "suggestedDescription": "Upper body rotation decelerates while lower body rotation accelerates to prepare for landing"
}
```

### Analysis Prompt

```
Analyze this snowboarding movement signal and provide insights about the body parts involved,
movement patterns, and coordination.

Signal Metadata:
- Name: {signalName}
- Phases: {phases}
- Duration: {duration} seconds
- Frame Count: {frameCount}
- FPS: {fps}

Pose Data (Key Frames):
{keyFramesJson}

Temporal Signals:
{temporalSignalsJson}

Body Part Relationships:
{relationshipsJson}

Please analyze:
1. Which body parts are moving? (upper body, lower body, arms, head, etc.)
2. What is the movement pattern? (rotation, extension, flexion, etc.)
3. Which body parts are accelerating vs decelerating?
4. What is the coordination pattern? (synchronized, inverse, sequential, etc.)
5. Are there any asymmetries? (left vs right differences)
6. What related movements might this be part of?
7. What coaching insights apply to this movement?

Respond in JSON format.
```

## Output from LLM

The LLM returns structured analysis:

```typescript
interface LLMAnalysis {
  bodyPartsInvolved: string[]; // e.g., ["upper_body", "lower_body"]
  movementType: string; // e.g., "counter_rotation"
  description: string; // human-readable description
  acceleratingParts: string[]; // body parts speeding up
  deceleratingParts: string[]; // body parts slowing down
  coordinationPattern: string; // e.g., "inverse", "synchronized", "sequential"
  asymmetries: string[]; // e.g., ["left arm faster than right"]
  relatedSignals: string[]; // e.g., ["arm_snap", "body_separation"]
  coachingInsights: string[]; // general coaching knowledge
  suggestedName: string; // refined signal name
  suggestedDescription: string; // refined description
}
```

## Implementation

### API Endpoint

```typescript
POST /api/temporal-signals/analyze
{
  "signalName": string;
  "phases": string[];
  "description": string;
  "frameCount": number;
  "duration": number;
  "fps": number;
  "keyFrames": {
    "start": PoseFrame;
    "middle": PoseFrame;
    "end": PoseFrame;
  };
  "temporalSignals": TemporalSignals;
  "relationships": Record<string, any>;
}

Response:
{
  "analysis": LLMAnalysis;
  "confidence": number; // 0-1
  "timestamp": Date;
}
```

### Service Implementation

```typescript
// backend/src/services/temporalSignalAnalysisService.ts

async function analyzeSignalSequence(
  signal: SignalSequenceDefinition,
  temporalSignals: TemporalSignals,
  keyFrames: PoseFrame[]
): Promise<LLMAnalysis> {
  // Prepare input for LLM
  const input = {
    signalName: signal.name,
    phases: signal.phases,
    description: signal.description,
    frameCount: temporalSignals.frameCount,
    duration: temporalSignals.duration,
    fps: temporalSignals.fps,
    keyFrames: {
      start: keyFrames[0],
      middle: keyFrames[Math.floor(keyFrames.length / 2)],
      end: keyFrames[keyFrames.length - 1],
    },
    temporalSignals,
    relationships: temporalSignals.relationships,
  };
  
  // Call LLM
  const response = await gemini.generateContent({
    systemPrompt: SYSTEM_PROMPT,
    userPrompt: formatAnalysisPrompt(input),
  });
  
  // Parse response
  const analysis = JSON.parse(response.text);
  
  return analysis;
}
```

## Example Analysis

### Input Signal: Counter-Rotation

```json
{
  "signalName": "counter_rotation",
  "phases": ["air", "landing"],
  "description": "Upper body slows rotation, lower body speeds up",
  "frameCount": 30,
  "duration": 1.0,
  "fps": 30,
  "temporalSignals": {
    "upper_body_rotation": {
      "position": [45, 42, 38, 32, 25, 18, 12, 8, 5, 3],
      "velocity": [-3, -4, -6, -7, -7, -6, -4, -3, -2],
      "acceleration": [-1, -2, -1, 0, 1, 2, 2, 1],
      "peakMagnitude": 45,
      "peakTiming": 0.0
    },
    "lower_body_rotation": {
      "position": [0, 2, 5, 9, 14, 20, 26, 31, 35, 38],
      "velocity": [2, 3, 4, 5, 6, 6, 5, 4, 3],
      "acceleration": [1, 1, 1, 1, 0, -1, -1, -1],
      "peakMagnitude": 38,
      "peakTiming": 1.0
    }
  }
}
```

### Expected Output

```json
{
  "bodyPartsInvolved": ["upper_body", "lower_body", "core"],
  "movementType": "counter_rotation",
  "description": "Upper body rotation decelerates while lower body rotation accelerates, creating separation that allows the rider to prepare for landing",
  "acceleratingParts": ["lower_body"],
  "deceleratingParts": ["upper_body"],
  "coordinationPattern": "inverse - upper body slows as lower body speeds up",
  "asymmetries": [],
  "relatedSignals": ["body_separation", "landing_preparation", "rotation_control"],
  "coachingInsights": [
    "This is a critical transition movement for landing",
    "Requires precise timing - upper body must slow at the right moment",
    "Lower body acceleration prepares for impact absorption",
    "Common issue: riders don't slow upper body enough"
  ],
  "suggestedName": "counter_rotation",
  "suggestedDescription": "Upper body rotation decelerates while lower body rotation accelerates to prepare for landing impact"
}
```

## Integration with Perfect Phase Storage

When storing a perfect phase, the system:

1. Extracts temporal signals
2. Calls LLM analysis
3. Stores both signals and analysis
4. Uses analysis for:
   - Categorization and search
   - Suggesting related signals
   - Understanding movement patterns
   - Generating coaching insights

```typescript
interface PerfectPhase {
  // ... other fields ...
  temporalSignals: TemporalSignals;
  llmAnalysis: LLMAnalysis;
  tags: string[]; // populated from llmAnalysis.bodyPartsInvolved
}
```

## Limitations & Considerations

1. **LLM is for understanding, not coaching**: The LLM helps categorize and understand movements, but coaching feedback comes from mathematical comparison.

2. **Pose data quality matters**: If pose keypoints are noisy or missing, LLM analysis will be less accurate.

3. **Context is limited**: The LLM only sees pose data and temporal signals, not video context or rider intent.

4. **Validation needed**: LLM suggestions should be reviewed by coaches before being used for categorization.

5. **Consistency**: Multiple analyses of the same movement should produce similar results (test for consistency).

## Testing Strategy

1. **Unit tests**: Test LLM prompt formatting and response parsing
2. **Integration tests**: Test full analysis pipeline with sample signals
3. **Validation tests**: Compare LLM suggestions to coach expertise
4. **Consistency tests**: Analyze same signal multiple times, verify consistency

## Future Enhancements

1. **Few-shot learning**: Provide examples of well-analyzed signals to improve consistency
2. **Feedback loop**: Allow coaches to correct LLM suggestions, improving future analyses
3. **Multi-language**: Support coaching terminology in different languages
4. **Signal library**: Build library of known signals with LLM analysis for reference
5. **Confidence scoring**: Return confidence scores for different aspects of analysis
